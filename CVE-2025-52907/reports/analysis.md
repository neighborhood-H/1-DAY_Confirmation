# CVE-2025-52907 분석 보고서

<!--
Title: CVE-2025-52907 — 분석 보고서
License: CC BY-NC 4.0
Copyright: neighborhood-H (2025)
SPDX: CC-BY-NC-4.0
-->

> **요약**: TOTOLINK X6000R 라우터의 웹 서버 바이너리(`/usr/sbin/shttpd`)에서 **입력값 검증 미흡**으로 인한 명령 삽입 취약점이 발견됨. `setWizardCfg` API를 통해 전달되는 여러 설정 필드(예: `vlanVidCpu`, `vlanVidLan*` 등)가 적절히 검증되지 않고 UCI(설정) 파일에 그대로 기록되어, 이를 사용하는 후속 스크립트/명령이 존재할 경우 **원격 명령 실행(RCE)**으로 이어질 수 있음. 본 문서는 펌웨어 역공학, IDA 정적 분석, QEMU 에뮬레이션, 취약 경로 재현을 정리한다.

---


## 1. 취약점 소개

### 1.1 취약점 개요

| 항목 | 내용 |
| --- | --- |
| 취약점 명칭 | **CVE-2025-52907** |
| 취약 유형 | 입력값 검증 미흡 (CWE-20) |
| 심각도 (CVSS) | 7.3 / High |
| 공격 조건 | 불완전한 입력값 처리로 악성 인수 삽입 가능 |
| 발생 위치 | `/usr/sbin/shttpd` (setWizardCfg 처리 경로) |
| PoC 공개 여부 | 없음 |

### 1.2 영향 받는 대상

| **영향 받는 제품** | **영향 받는 펌웨어 버전** |
| --- | --- |
| **TOTOLINK X6000R (X6000R)** | **V9.4.0cu.1360_B20241207 까지** |

### 1.3 테스트 버전

- 취약 버전: `V9.4.0cu.1360_B20241207`  
  (다운로드: https://www.totolink.net/home/menu/detail/menu_listtpl/download/id/247/ids/36.html)

- 패치 버전: `V9.4.0cu.1498_B20250826`  
  (다운로드: https://www.totolink.net/home/menu/detail/menu_listtpl/download/id/247/ids/36.html)

---

## 2. 정적 분석

### 2.1 펌웨어 구조 (SquashFS 루트)

```text
squashfs-root/
├── bin/
│   └── busybox
├── dev/
├── etc/
├── init/
├── lib/
├── lib64 -> lib
├── mnt/
├── overlay/
├── proc/
├── rom/
├── root/
├── sbin/
├── sys/
├── tmp/
├── usr/
│   └── sbin/
│       └── shttpd    # 웹 서버 바이너리 (취약 처리 포함)
├── var/
├── web/
│   ├── wizard.html
│   ├── phone/
│   │   └── wizard.html
│   └── static/
│       └── js/
│           └── topicurl.js
└── www/
```

### 2.2 펌웨어 추출

```bash
binwalk -Me TOTOLINK_C8380R_X6000R_IP04499_MT7981_SPI_16M256M_V9.4.0cu.1360_B20241207_ALL.web
```

### 2.3 Root cause 발견 과정 (요약)

- 프론트엔드(웹) 코드에서 `setWizardCfg` 호출 확인 (`web/wizard.html`, `web/phone/wizard.html`, `web/static/js/topicurl.js`).
- 모든 API는 단일 엔드포인트로 전송: `globalConfig.cgiUrl` → `/cgi-bin/cstecgi.cgi`.
- `usr/sbin/shttpd` 바이너리 내부에서 `setWizardCfg`를 처리하는 코드(핸들러)가 존재함을 확인.
- 취약 원인: 클라이언트에서 전달된 여러 설정 문자열을 `Uci_Set_Str` 등으로 UCI 설정에 **검증 없이 저장**하고, 이후 `doSystem()` 또는 외부 스크립트가 해당 설정 값을 셸 컨텍스트로 사용함으로써 명령 삽입 기회 생성.

### 2.4 주요 증거 및 분석 (shttpd 내부)

#### 2.4.1 `sub_40C08C` — JSON 키에서 문자열 추출

`sub_40C08C`는 JSON 객체에서 키를 찾아 문자열을 반환하는 유틸리티로, POST로 전송된 JSON 데이터를 파싱해 사용자 통제 입력을 바이너리 내부로 들여온다.

**의사코드**:

```c
char *__fastcall sub_40C08C(__int64 a1, __int64 a2)
{
  if (!json_object_object_get_ex(a1, a2, &v3))
    return "";
  result = (char *)json_object_get_string(v3);
  if (!result)
    return "";
  return result;
}
```

→ 반환되는 문자열은 사용자 입력이며, 그대로 UCI 설정에 저장되고 후속 로직에 사용될 수 있다.

#### 2.4.2 `sub_4243AC` — `setWizardCfg` 처리 (취약 경로 1)

`sub_4243AC`는 `topicurl == "setWizardCfg"` 요청을 처리한다. 함수는 여러 입력 필드를 `sub_40C08C`로 추출하고 `Uci_Set_Str`로 UCI에 저장한 후, 조건에 따라 `doSystem()` 호출을 수행한다.

**핵심 취약점 포인트**:

- `vlanVidCpu`, `vlanVidLan1`~`vlanVidLan4` 등 VLAN 관련 값들을 `Uci_Set_Str`로 **검증 없이 저장**.
- 정수 처리(예: `atoi(v12)`)는 내부 논리용으로 사용되지만, 원래 문자열은 그대로 저장되어 이후 다른 구성 스크립트 또는 명령에서 사용될 위험이 있음.
- 일부 코드 경로에서 `doSystem("uci set igmpproxy.@phyint[0].direction='%s'", v23)` 등 포맷 기반 시스템 호출 사용.

**요약된 의사코드**:

```c
// 입력 추출
v3 = sub_40C08C(a1, "topicurl");
...
v12 = sub_40C08C(a1, "vlanVidCpu");
// UCI에 원문 저장
Uci_Set_Str(10LL, "iptv", "vlanVidCpu", v12);

// 내부에서는 atoi로 정수 변환하여 사용
v18 = atoi(v8);
if (v18) {
  // 다양한 UCI 설정 반영
  Uci_Set_Str(...);
  // 특정 조건에서 doSystem 호출
  doSystem("uci set igmpproxy.@phyint[0].direction='%s'", v23);
  doSystem("uci commit igmpproxy");
}
```

위 흐름에서 `v12` 같은 필드에 악성 입력(예: `10; reboot; #`)을 넣으면, 저장된 문자열이 후속 스크립트/명령어에서 검증 없이 확장/실행될 경우 RCE로 이어질 수 있다.

#### 2.4.3 `sub_427A34` — 추가 취약 경로 (취약 경로 2)

문서 내 다른 핸들러 경로에서도 유사하게 JSON 입력을 추출하여 UCI에 쓰고, 시스템 명령을 호출하는 코드 패턴이 관찰되어 동일한 클래스의 취약성이 존재할 가능성이 있다.



---

## 3. 에뮬레이션 (QEMU User-mode)

### 3.1 QEMU 바이너리 주입

로컬 분석 환경에서 AArch64(또는 대상 아키텍처)에 맞는 QEMU 유저모드를 바이너리를 `usr/bin`에 복사.

```bash
sudo cp /usr/bin/qemu-aarch64 ./usr/bin
```

### 3.2 마운트 & chroot

```bash
sudo mount --bind /dev ./dev
sudo mount --bind /proc ./proc
sudo mount --bind /sys ./sys
sudo rm -rf ./var
sudo mkdir -p ./var/run
sudo chroot . ./usr/bin/qemu-aarch64 /bin/sh
```

### 3.3 웹 서버 실행 (chroot 내부)

```sh
ubusd &
/usr/sbin/shttpd -root /web
```

> 참고: 실제 라우터의 환경(uci, network 데몬 등)을 모사하려면 추가 설정이 필요함. 실기기에서의 행위와 다를 수 있으므로 격리된 실험 환경에서만 테스트해야 함.

---

## 4. Exploit / PoC (연구 재현용)

> 주의: PoC는 교육·연구 목적이며, 패치되지 않은 기기에 대한 무단 테스트는 불법일 수 있다. 반드시 로컬 격리 환경에서만 사용.

### 4.1 공격 벡터 요약

- 엔드포인트: `POST /cgi-bin/cstecgi.cgi` (Content-Type: application/json)
- 본문(JSON) 예시: `{ "topicurl": "setWizardCfg", ... }`
- 취약 파라미터: `vlanVidCpu`, `vlanVidLan1`~`vlanVidLan4`, 기타 UCI에 기록되는 문자열 필드

### 4.2 공격 시나리오 (개념)

1. 공격자는 API 엔드포인트에 직접 POST 요청을 전송하거나, 웹 인터페이스를 통해 `setWizardCfg` 호출을 유발한다.
2. `setWizardCfg` 핸들러는 JSON에서 값을 추출하여 `Uci_Set_Str`로 UCI 설정에 저장.
3. 이후 시스템에서 해당 설정 값을 사용해 `doSystem()` 또는 스크립트를 호출하면, 저장된 악성 문자열이 셸에서 확장·실행될 수 있음.

### 4.3 안전한 PoC(증명용 — 무해한 작업)

**주의**: 실제 공격성 코드는 절대 제공하지 않음. 연구 목적의 무해한 PoC 예시(설정 저장 확인):

```bash
curl 'http://<ROUTER_IP>/cgi-bin/cstecgi.cgi' \
  -H 'Content-Type: application/json;charset=UTF-8' \
  -X POST \
  --data-raw '{"topicurl":"setWizardCfg","vlanVidCpu":"TEST_INJECTION_123","vlanVidLan1":"2"}'
```

이 요청이 성공하면 UCI 설정에 `TEST_INJECTION_123`이 기록되는지(또는 관련 로그에 반영되는지)를 확인하여 입력이 저장되는 동작을 검증할 수 있다.


---

## 5. 재현 체크리스트

- [ ] 펌웨어 추출 및 SquashFS 루트 준비
- [ ] `qemu-aarch64` 주입 완료
- [ ] `/dev`, `/proc`, `/sys` 바인드 마운트 완료
- [ ] chroot 진입 및 `ubusd`, `shttpd` 실행
- [ ] 대상 펌웨어가 취약 버전인지 확인 (`V9.4.0cu.1360_B20241207` 등)
- [ ] 네트워크 격리 환경(로컬 랩) 구성
- [ ] 비파괴적 PoC(설정 저장 확인) 수행

---

## 6. 완화 및 패치 요약

- **입력 검증 강화**: 모든 문자열 입력(특히 `vlanVid*`, `ssid`, `tz`, `loginpass` 등)을 화이트리스트 기반 검증 또는 엄격한 파싱(숫자 필드에는 숫자만 허용)으로 처리.
- **UCI 저장 전 필터**: `Uci_Set_Str` 호출 전에 입력 값에 대해 금지문자(예: `;`, `&`, "`", `$(` 등) 제거 또는 인코딩 적용.
- **명령 실행 변경**: `doSystem()`에서 포맷 기반 문자열 결합을 피하고, 가능한 경우 exec 계열(매개변수 배열) 사용 및 입력을 절대 셸 컨텍스트로 전달하지 않음.
- **인증/권한 강화**: 중요한 구성 API(`setWizardCfg` 등)는 관리자 권한/세션 검증을 요구하도록 변경.
- **패치 적용**: 제조사에서 제공하는 패치(예: V9.4.0cu.1498_B20250826 이후)를 적용.

---

## 7. 참고 자료 및 주의사항

- Unit42 분석 페이지(관련 참조): https://unit42.paloaltonetworks.com/totolink-x6000r-vulnerabilities/
- TOTOLINK 공식 펌웨어 다운로드: https://www.totolink.net

> **주의**: 본 문서는 교육·연구 목적이며, 패치 이전 기기에 대한 무단 테스트를 금한다. 모든 PoC는 **격리된 로컬 환경**에서만 사용한다.