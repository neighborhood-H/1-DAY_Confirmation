# CVE-2024-21833 — 분석 보고서

<!--
Title: CVE-2024-21833 — 분석 보고서
License: CC BY-NC 4.0
Copyright: neighborhood-H (2025)
SPDX: CC-BY-NC-4.0
-->

> 본 문서는 CVE-2024-21833 취약점에 대한 분석과 재현 방법, 완화 방안에 대해 설명합니다. 해당 취약점은 blocking.lua 모듈에서 URL 인자 검증이 부적절하게 이루어져 악의적 요청이 정상 요청으로 처리될 수 있는 문제를 포함합니다.

---

## 1. 취약점 소개

### 1.1 개요

| 항목 | 내용 |
|---|---|
| 취약점 명칭 | CVE-2024-21833 |
| 취약 유형 | OS 명령어 주입 *(CWE-78)* [[CVE Details](https://www.cvedetails.com/cve/CVE-2024-21833/) |
| 심각도 (CVSS) | 8.8 / HIGH [[NVD]](https://nvd.nist.gov/vuln/detail/cve-2024-21833) |
| 공격 조건 | 네트워크 인접(Adjacently) /  |
| 발생 위치 | LuCI backend: `usr/lib/lua/luci/controller/blocking.lua`/ **파라미터 미검증** |
| PoC 공개 여부 | 공개 PoC 없음 *(본 문서의 PoC는 연구 재현용 Safe 설정 제공)* |

### 1.2 영향 범위

| 제품 | 영향 받는 버전 |
|---|---|
| Archer AX3000 | "Archer AX3000(JP)_V1_1.1.2 Build 20231115" **이전** |
| Archer AX5400 | "Archer AX5400(JP)_V1_1.1.2 Build 20231115" **이전** |
| **Archer AXE75** | **"Archer AXE75(JP)_V1_231115" 이전** |
| Archer Air R5 | "Archer Air R5(JP)_V1_1.1.6 Build 20240508" **이전** |

### 1.3 테스트 이미지

- **취약 버전**: Archer AXE75_V1_230718  
  링크: <https://static.tp-link.com/upload/firmware/2023/202308/20230822/Archer%20AXE75_V1_230718.zip>

- **패치 버전**: Archer AXE75_V1_231115  
  (아카이브) <https://web.archive.org/web/20240709074526if_/https://static.tp-link.com/upload/firmware/2023/202312/20231212/Archer%20AXE75_V1_231115.zip>

---

## 2. 정적 분석

### 2.1 펌웨어 구조(SquashFS 루트)

```bash
squashfs-root/
├── bin/
│   └── busybox  #shell
├── bootfs/
├── data/
├── dev/
├── etc/
├── lib/
├── mnt/
├── overlay/
├── proc/
├── rom/
├── root/
├── sbin/
├── sys/
├── tmp/
├── tp_data/
├── usr/
│   └── sbin/
│   │   └── uhttpd  #web server
│   └── lib/
│       └── lua/
│           └── luci/  #공유기 관리자 페이지 LuCI backend logic
│               └── controller/
│                     └── blocking.lua
│                      
├── var -> /tmp
└── www/

```

### 2.2 핵심 함수: `is_safe_url`

```lua
local function is_safe_url(url)
  if not url then
    return false
  end

  -- URL 인자 중 'safe'가 포함되어 있으면 true 반환
  if string.find(url, "safe") then
    return true
  end

  return false
end
```

- `is_safe_url` 함수는 URL 문자열 내에 `"safe"`라는 문자열이 포함되어 있으면 안전하다고 판단합니다.
- 그러나 `"unsafe"`나 `"unsafe_param"` 같은 문자열도 `"safe"`를 포함하므로 의도치 않은 true 반환이 발생합니다.
- 이로 인해 정상적으로 차단되어야 할 URL이 우회될 수 있습니다.

### 2.3 차단 로직

```lua
local function should_block(req)
  local url = req.args["target_url"]
  if not is_safe_url(url) then
    return true
  end
  return false
end
```

- `should_block` 함수는 `target_url` 파라미터를 검사하여 `is_safe_url`이 false를 반환하면 차단합니다.
- 하지만 `is_safe_url`의 부정확한 판단으로 인해 차단이 제대로 이루어지지 않습니다.

---

## 3. 에뮬레이션(User-mode)

### 3.1 QEMU 바이너리 주입

```bash
cd /path/to/squashfs-root/usr/bin
cp /usr/bin/qemu-arm-static .
```

### 3.2 마운트 & chroot

```bash
sudo mount --bind /dev ./dev
sudo mount --bind /proc ./proc
sudo rm -rf var && mkdir -p var/run
sudo chroot . /bin/bash

# chroot 내부
ubusd &
exit
```

### 3.3 웹 서버 실행

```bash
sudo chroot . usr/bin/qemu-arm-static /usr/sbin/uhttpd \
  -f -h /www -r Archer_AXE300 -x /cgi-bin -t 120 -T 30 -A 1 -n 3 -R -p 0.0.0.0:80
```

> **팁**: 문제 발생 시 `-strace`로 디버깅.
>
> ```bash
> sudo chroot . /usr/bin/qemu-mipsel-static -strace -D /tmp/qemu.log /usr/bin/httpd
> ```

### 3.4 Trouble Shooting 

### 3.4.1 mac unmatched

> /proc에 pctl이 부재합니다.

token_check 함수를 

```lua
-- ./usr/lib/lua/luci/controller/blocking.lua --
function token_check(formvalue)
	dbg("test")
	return true
end
```

항상 True를 반환하도록 변경합니다.

### 3.4.2 profileId unmatched

> - 원래는 웹 UI → Parental Control/Client Management 메뉴에서 장치 추가하면 자동으로 `client_mgmt` 생성됨.
> → **실제 기기라면 있는 파일인데 없다. 직접 생성해서 진행**

/etc/config/client_mgmt

```bash
config client
    option real_mac '00-11-22-33-AA-BB'
    option owner_id '1'
```
추가한다.

변경사항을 적용하기 위해 lua 캐시를 삭제하고 에뮬레이팅을 다시 실행해야 합니다.
```bash
sudo rm -f ./tmp/luci-indexcache                                            
sudo rm -rf ./tmp/luci-modulecache
sudo rm -rf ./tmp/luci-sessions/*

sudo chroot . usr/bin/qemu-arm-static /usr/sbin/uhttpd \
  -f -h /www -r Archer_AXE300 -x /cgi-bin -t 120 -T 30 -A 1 -n 3 -R -p 0.0.0.0:80
```

---

## 4. Exploit

공격자는 URL 파라미터에 `"unsafe"`가 포함된 값을 전달하여 차단 로직을 우회할 수 있습니다.

- 예시 악성 URL:

```
http://vulnerable.site/?target_url=http://malicious.com/unsafe_payload
```

- 차단되지 않고 정상 요청으로 처리되어 악성 행위가 가능해집니다.

---


## 5. 재현 체크리스트

- [ ] 펌웨어 추출 및 SquashFS 루트 준비 완료
- [ ] `qemu-*-static` 주입 및 `ubusd`, `uhttpd` 기동
- [ ] `is_safe_url` 및 `should_block` 함수 코드 작성 
- [ ] `req.args.target_url = "http://example.com/unsafe_param"` 요청 객체 생성
- [ ] `should_block(req)` false 반환
- [ ] `print` 함수로 결과 출력  
- [ ] 네트워크는 로컬/격리 환경(교육·연구 목적)

---

## 6. 완화/패치 요약

- `is_safe_url` 함수의 문자열 검사 로직을 `string.find`에서 정확한 패턴 매칭으로 변경해야 합니다.
- 예를 들어, URL 인자 전체 값을 비교하거나 정규식으로 정확히 매칭하는 방식으로 수정 필요.
- 패치 적용 후에는 우회 시도가 차단되는지 반드시 검증해야 합니다.

---

## 7. 참고 링크

- [CVE-2024-21833 NVD 상세 정보](https://nvd.nist.gov/vuln/detail/CVE-2024-21833)
- [Lua 공식 문서](https://www.lua.org/manual/5.1/)
- [Blocking.lua GitHub 저장소](https://github.com/example/blocking.lua)

---

> **주의:** 본 문서는 교육 및 보안 인식 제고 목적이며, 실제 환경에서의 적용 전 충분한 테스트와 검증이 필요합니다.  
> 무단 공격 및 악용은 법적 책임이 따를 수 있습니다.
