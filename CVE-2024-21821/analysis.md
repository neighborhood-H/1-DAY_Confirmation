# 1. CVE-2024-21821 소개

## 1.1. 취약점 개요

| 항목 | 내용 |
| --- | --- |
| 취약점 명칭 | CVE-2024-21821 |
| 취약 유형 | OS 명령어 주입 (CWE8) [CVE Details+1](https://www.cvedetails.com/cve/CVE-2024-21821/) |
| 심각도 (CVSS) | 8.0 / HIGH [NVD+1](https://nvd.nist.gov/vuln/detail/cve-2024-21821) |
| 공격 조건 | 네트워크 인접(adjacently) / 인증된 접근 |
| 발생 위치 | TP-Link Archer 라우터의 folder_sharing.lua |
| PoC 공개 여부 | 없음 |

## 1.2. 영향 받는 대상

| **영향 받는 제품** | **영향 받는 펌웨어 버전** |
| --- | --- |
| TP-Link Archer AX3000 | “Archer AX3000(JP)_V1_1.1.2 Build 20231115” 이전 버전 |
| TP-Link Archer AX5400 | “Archer AX5400(JP)_V1_1.1.2 Build 20231115" 이전 버전 |
| **TP-Link Archer AXE75** | **"Archer AXE75(JP)_V1_231115" 이전 버전** |
| TP-Link Air R5 | "Archer Air R5(JP)_V1_1.1.6 Build 20240508" 이전 펌웨어 버전 |

## 1.3. 테스트 버전

- Archer AXE75_V1_230718(취약한 펌웨어 버전)

[https://static.tp-link.com/upload/firmware/2023/202308/20230822/Archer AXE75_V1_230718.zip](https://static.tp-link.com/upload/firmware/2023/202308/20230822/Archer%20AXE75_V1_230718.zip)

- Archer AXE75_V1_231115(패치 적용 버전)

[https://web.archive.org/web/20240709074526if_/https://static.tp-link.com/upload/firmware/2023/202312/20231212/Archer AXE75_V1_231115.zip](https://web.archive.org/web/20240709074526if_/https://static.tp-link.com/upload/firmware/2023/202312/20231212/Archer%20AXE75_V1_231115.zip)

# 2. 정적 분석

## 2.1. 펌웨어 구조

펌웨어의 파일 시스템 루트 디렉터리(squashfs-root)의 주요 구조는 아래와 같다.

```bash
squashfs-root/
├── bin/
│   └── busybox  #shell
├── bootfs/
├── data/
├── dev/
├── etc/
├── lib/
├── mnt/
├── overlay/
├── proc/
├── rom/
├── root/
├── sbin/
├── sys/
├── tmp/
├── tp_data/
├── usr/
│   └── sbin/
│   │   └── uhttpd  #web server
│   └── lib/
│       └── lua/
│           └── luci/  #공유기 관리자 페이지 LuCI backend logic
│               └── controller/
│                   ├── admin/
│                   │   └── folder_sharing.lua  #CVE-2024-21821 원인 코드
│                   └── blocking.lua
├── var -> /tmp
└── www/

```

## 2.2. 펌웨어 추출

![image.png](attachment:3c34baf5-6d68-4fbc-9eb1-a1a42e143632:image.png)

[1.3. 테스트 버전] 항목에서 다운로드 받은 zip 파일을 풀어 bin 파일을 binwalk로 추출한다.

```bash
~/Archer230718$ binwalk -Me 'axe75v1-axe5400-up-ver1-1-8-P1[20230718-rel47014]_nosign_2023-07-28_09.36.20.bin' 
```

## 2.3. Diffing

> 영향 받는 버전인 ‘Archer AXE75_V1_230718’과 패치된 ‘Archer AXE75_V1_231115’를 비교한다.
> 

```bash
~$ diff -qr /path/to/Archer AXE75_V1_230718/squashfs-root/ \
/path/to/Archer AXE75_V1_231115/squashfs-root/
```

결과: 

1. 업데이트 버전 관리

Files ./Archer230718/_axe75v1-axe5400-up-ver1-1-8-P1[20230718-rel47014]_nosign_2023-07-28_09.36.20.bin.extracted/squashfs-root/etc/partition_config/soft-version and ./Archer231115/_axe75v1-axe5400-up-ver1-1-9-P1[20231115-rel37295]_nosign_2023-11-15_15.46.25.bin.extracted/squashfs-root/etc/partition_config/soft-version differ

1. **CVE-2024-21821에 해당하는 패치.**

Files ./Archer230718/_axe75v1-axe5400-up-ver1-1-8-P1[20230718-rel47014]_nosign_2023-07-28_09.36.20.bin.extracted/squashfs-root/usr/lib/lua/luci/controller/admin/folder_sharing.lua and ./Archer231115/_axe75v1-axe5400-up-ver1-1-9-P1[20231115-rel37295]_nosign_2023-11-15_15.46.25.bin.extracted/squashfs-root/usr/lib/lua/luci/controller/admin/folder_sharing.lua differ

1. CVE-2024-21833에 해당하는 패치.

Files ./Archer230718/_axe75v1-axe5400-up-ver1-1-8-P1[20230718-rel47014]_nosign_2023-07-28_09.36.20.bin.extracted/squashfs-root/usr/lib/lua/luci/controller/blocking.lua and ./Archer231115/_axe75v1-axe5400-up-ver1-1-9-P1[20231115-rel37295]_nosign_2023-11-15_15.46.25.bin.extracted/squashfs-root/usr/lib/lua/luci/controller/blocking.lua differ

### 2.3.1 squashfs-root/usr/lib/lua/luci/controller/admin/folder_sharing.lua

아래 명령어로 변경 사항을 확인할 수 있다.

```bash
~$ diff -rui /path/to/squashfs-root_230718/usr/lib/lua/luci/controller/admin/folder_sharing.lua \
/path/to/squashfs-root_231115/usr/lib/lua/luci/controller/admin/folder_sharing.lua
```

```bash
--- ./Archer230718/_axe75v1-axe5400-up-ver1-1-8-P1[20230718-rel47014]_nosign_2023-07-28_09.36.20.bin.extracted/squashfs-root/usr/lib/lua/luci/controller/admin/folder_sharing.lua	2023-07-28 10:09:15.000000000 +0900
+++ ./Archer231115/_axe75v1-axe5400-up-ver1-1-9-P1[20231115-rel37295]_nosign_2023-11-15_15.46.25.bin.extracted/squashfs-root/usr/lib/lua/luci/controller/admin/folder_sharing.lua	2023-11-15 16:27:48.000000000 +0900
@@ -690,11 +690,14 @@
         data["authentication"] = uci_r:get(UCICFG, "global", "auth_all")
     elseif operation == "write"  
         data["authentication"] = form["authentication"]
+        if data["authentication"] ~= "on" and data["authentication"] ~= "off" then
+            return false, "invalid arguments"
+        end
         local username = uci_r:get(UCICFG, "account1", "username")
         local password = uci_r:get(UCICFG, "account1", "password")
         uci_r:set(UCICFG, "global", "auth_all", data["authentication"])
-        local cmd = "change_smb_conf " .. data["authentication"] .. " " .. username .. " " .. password
-        sys.call(cmd)
+        local cmd = {"/sbin/change_smb_conf", data["authentication"], username, password}
+        subprocess.call(cmd)
         cfg_changed = true
     else
         return false, "Invalid operation " .. operation

```

패치로 인해 추가된 사항은 아래와 같다.

> **입력값 검증 추가**
> 

변경 전:

```lua
data["authentication"] = form["authentication"]
```

사용자로부터 받은 `from["authentication"]` 값을 아무런 검증 없이 그대로 `data["authentication"]` 변수에 할당했다.

변경 후:

```lua
if data["authentication"] ~= "on" and data["authentication"] ~= "off" then
    return false, "invalid arguments"
end
```

`data["authentication"]` 값이 “on” 또는 “off”가 아닐 경우, “invalid arguements” 메시지를 반환하며 처리를 중단하는 검증 로직이 추가되었다.

추측:

- 예상치 못한 값이 시스템 명령어에 사용되는 것을 막기 위한 조치.

> **안전한 명령어 실행 방식으로 변경**
> 

변경 전:

```lua
local cmd = "change_smb_conf " .. data["authentication"] .. " " .. username .. " " .. password
sys.call(cmd)
```

문자열을 단순히 `..`으로 이어 붙여 하나의 명령어를 만들고, 이 명령어를 shell을 통해 실행하는 `sys.call(cmd)` 함수를 사용했다.

변경 후:

```lua
local cmd = {"/sbin/change_smb_conf", data["authentication"], username, password}
subprocess.call(cmd)
```

실행할 명령어와 인자들을 배열 형태로 분리하여 `subprocess.call(cmd)` 함수로 실행하도록 변경되었다.

추측:

- 변경 전 방식의 문제점: 만약 공격자가 `data["authentication"]` 값으로 / `on; rm -rf /` 와 같은 악의적인 문자역으은 악의적인 문자열을 입력할 수 있다면, 최종 명령어는 `change_smb_conf on; rm -rf / ...` 가 될 것이다.
- 변경 후: 명령어와 인자를 분리해서 시스템에 전달하면 `on; rm -rf /` 와 같은 입력값은 하나의 문자열 인자로 취급되어 명령어 되어 명령어 주입 공격이 차단될 것이다.

## 2.4. 소스 코드 분석 (folder_sharing.lua)

LuCI 컨트롤러의 진입점(Entry Point) 함수:`index()` 정의와 요청 분배 함수: `folder_index()`는 아래와 같다.

```lua
-- line 1199 to 1205
function index()
    entry({"admin", "folder_sharing"}, call("folder_index")).leaf = true
end

function folder_index()
    ctl._index(folder_dispatch)
end
```

- index(): 기본 URL(cgi-bin/luci/admin/folder_sharing)을 이 파일이 처리하도록 등록한다.
- folder_index(): 실제 요청 처리를 folder_dispatch 함수에게 넘긴다.

```lua
-- line 1207 to 1218
function folder_dispatch(http_form)
    -- ... (hook function definition) ...

    return ctl.dispatch(folder_tbl, http_form, {post_hook = hook})
end
```

`folder_dispatch` 함수는 `ctl.dispatch`라는 LuCI 헬퍼 함수를 호출하여 요청을 분배한다.

`ctl.dispatch` 함수는 URL의 나머지 부분과 폼 데이터(`http_form`)을 보고 `folder_tbl` 에서 어떤 함수를 실행할지 결정한다.

```lua
-- line 1149 ~
local folder_tbl = {
    server = {
			...
    },
    settings = {
			...
    },
    mode = {
			...
    },
    auth = {
        ["read"]  = {cb = share_auth},
        ["write"] = {cb = share_auth},
    },
    all = {
			...
    },
    ...

```

- 사용할 엔드포인트는 `/cgi-bin/luci/admin/folder_sharing/auth` 이다.
- LuCI는 기본 경로인 `/admin/folder_sharing` 다음의 경로 조각인 ‘auth’를 `folder_tbl` 의 키로 사용한다.
- `folder_tbl` 에서 auth 키를 찾으면 { [”read”] = {cb = share_auth}, [”write”] = {cb = share_auth} } 테이블이 나온다.
- PoC에서 `operation=write` 라는 데이터를 POST 요청으로 보낼 것이다.
- `ctl.dispatch` 는 이 operation 값을 보고 auth 테이블 내에서 ‘write’ 키를 찾는다.
- write 키에 해당하는 값인 {cb = share_auth}이며, cb는 callback 함수를 의미한다.
- 결론적으로 `share_auth` 함수가 호출되도록 연결된다.

요약: 

URL Path (/auth) → `folder_tbl`의 키 (auth) → Form 데이터 (operation=write) → 하위 테이블의 키 (write) → 콜백 함수 (share_auth)

# 3. Emulation

qemu user mode 에뮬레이션을 위한 세팅이다. ubusd를 이용해 uhttpd를 실행한다.

## 3.1. qemu-arm-static 주입

```bash
cd /path/to/squashfs-root/usr/bin
cp /usr/bin/qemu-arm-static .
```

## 3.2. mount 설정 및 chroot로 진입

mount 설정

```bash
sudo mount --bind /dev ./dev
sudo mount --bind /proc ./proc
sudo rm -rf var
mkdir -p var/run
```

shell에 접근하여 ubusd 실행

```bash
sudo chroot . bin/bash

(busybox)# ubusd &
# exit
```

웹 서버 실행

```bash
sudo chroot . usr/bin/qemu-arm-static /usr/sbin/uhttpd -f -h /www -r Archer_AXE300 -x\
/cgi-bin -t 120 -T 30 -A 1 -n 3 -R -p 0.0.0.0:80
```

strace 옵션으로 실행 에러를 확인할 수 있다.

```bash
sudo chroot . /usr/bin/qemu-mipsel-static \
 -strace -D /tmp/qemu.log /usr/bin/httpd
```

## 3.3. Trouble Shooting

usbshare 기능을 이용해 취약점을 트리거 하는데 문제가 발생한다.

`/etc/config/usbshare` 에 다음과 같이 코드가 있다.

![image.png](attachment:59322ef3-b681-43d0-a0ec-366f49202b89:image.png)

account는 usbshare 기능에 사용될 사용자 계정 프로필을 구분하기 위한 이름이다.

그러나 account1 을 참조하는 

```python
local username = uci_r:get(UCICFG, "account1", "username")
local password = uci_r:get(UCICFG, "account1", "password")
```

해당 코드에서 오류 발생

```python
/usr/lib/lua/luci/dispatcher.lua:495: Failed to execute call dispatcher target for entry '/admin/folder_sharing'. The called action terminated with an exception: ...usr/lib/lua/luci/controller/admin/folder_sharing.lua:696: attempt to concatenate local 'password' (a nil value) stack traceback: [C]: in function 'assert' /usr/lib/lua/luci/dispatcher.lua:495: in function 'dispatch' /usr/lib/lua/luci/dispatcher.lua:216: in function </usr/lib/lua/luci/dispatcher.lua:215> /usr/lib/lua/luci/dispatcher.lua:495: Failed to execute call dispatcher target for entry '/admin/folder_sharing'. The called action terminated with an exception: ...usr/lib/lua/luci/controller/admin/folder_sharing.lua:696: attempt to concatenate local 'password' (a nil value) stack traceback: [C]: in function 'assert' /usr/lib/lua/luci/dispatcher.lua:495: in function 'dispatch' /usr/lib/lua/luci/dispatcher.lua:216: in function </usr/lib/lua/luci/dispatcher.lua:215> /usr/lib/lua/luci/dispatcher.lua:495: Failed to execute call dispatcher target for entry '/admin/folder_sharing'. The called action terminated with an exception: ...usr/lib/lua/luci/controller/admin/folder_sharing.lua:696: attempt to concatenate local 'password' (a nil value) stack traceback: [C]: in function 'assert' /usr/lib/lua/luci/dispatcher.lua:495: in function 'dispatch' /usr/lib/lua/luci/dispatcher.lua:216: in function </usr/lib/lua/luci/dispatcher.lua:215>
```

account1을 추가해야 한다.

![image.png](attachment:4ee5231d-6c26-49d2-adac-4c4561d7a9b5:image.png)

성공적으로 접근 가능!

![image.png](attachment:46e883c8-6f8f-4bda-9e39-2716bcc7e1e9:image.png)