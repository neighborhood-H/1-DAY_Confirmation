# CVE-2024-38471 — 분석 보고서

<!--
Title: CVE-2024-38471 — 분석 보고서
License: CC BY-NC 4.0
Copyright: neighborhood-H (2025)
SPDX: CC-BY-NC-4.0
-->

---

> 본 문서는 CVE-2024-38471 취약점에 대한 상세 분석(정적·동적), 재현 시도 내역(실패 포함) 및 완화 방안에 대해 정리합니다. 교육·연구 목적의 분석이며, 패치 이전 기기에 대한 무단 실험은 금합니다.

## 요약

- **취약점 요약**: 웹 기반 설정 복구/복원 로직에서 외부로부터 입력되는 복구 파일(또는 특정 필드)을 적절히 검증하지 않아, 복원 작업 흐름 중 명령어 실행 경로에 악의적 문자열이 삽입될 수 있음(잠재적 OS 명령 주입).
- **영향 제품(예시)**: 제조사 A의 가정용 라우터 라인업 (분석 대상 펌웨어에 한함).
- **심각도**: 중–상 (구체적 영향은 공격 조건·인증 유무에 따라 다름).
- **재현 시도 결과**: 익스플로잇 시도를 수행했으나 환경 제약(에뮬레이션 한계, 런타임 의존 라이브러리 부족, 복원 리다이렉트/인증 흐름 문제 등)으로 **최종 RCE 달성에는 실패**. 실패 원인 및 남은 조사 포인트는 본문에 정리.

---

## 1. 취약점 소개

### 1.1 개요

| 항목 | 내용 |
|---:|---|
| 취약점 명칭 | CVE-2024-38471 |
| 취약 유형 | 입력값 검증 미흡 → 잠재적 OS 명령어 주입 (CWE-78 / CWE-20 연관) |
| 영향 위치 | 펌웨어의 복원(restore) / backup 파일 처리 로직 |
| 공격 조건 | 복원 기능 접근 권한(인증 여부는 구현에 따라 다름), 조작된 백업 파일 업로드 가능 |
| PoC 공개 여부 | 없음 (본 문서에선 연구 목적의 재현 시도 포함) |

### 1.2 영향 범위 (분석 대상)

- 테스트 펌웨어: `Archer_AXE75_V1_230718` (예시)  
- 패치 확인 대상 펌웨어: `Archer_AXE75_V1_240320` 이상(패치 적용 여부 확인 권장)

> 실제 영향 범위는 제조사별/모델별 구현 차이에 따라 달라질 수 있으므로 각 기기별 펌웨어를 확인해야 합니다.

---

## 2. 정적 분석

### 2.1 펌웨어 추출 및 구조 파악

- `binwalk -Me` 로 펌웨어를 추출하여 SquashFS 루트를 확보.
- 주요 경로:
```bash
squashfs-root/
├─ usr/lib/lua/        # LuCI / lua 스크립트
├─ www/                # 관리 UI
├─ usr/sbin/uhttpd     # 웹 서버
├─ etc/                # 설정 파일
└─ cgi-bin/            # CGI 엔드포인트 (또는 uhttpd -x 경로)
```

### 2.2 코드 검색(키워드/함수)

- 복원/백업 관련 문자열 검색: `restore`, `backup`, `merge_rtor_configs`, `load_backup`, `merge_rtor_configs`, `setWizardCfg` 등.
- 발견: 복원 관련 로직이 LuCI Lua 스크립트 및 CGI 바이너리/라이브러리 쪽에서 처리되고 있음.

### 2.3 의심 지점

- 복원 파일을 파싱하여 내부 필드를 시스템 설정(UCI 등)에 쓰는 흐름에서 원본 문자열을 그대로 파일/설정에 저장하는 코드 패턴 확인.
- 저장된 값이 이후 `doSystem()`, `os.execute()` 또는 `sys.call()` 형태로 쉘 명령을 호출하는 코드와 결합되는 지점이 존재(또는 존재할 가능성 있음).
- 몇몇 필드(예: 호스트명, 스크립트 파라미터, VLAN/인터페이스 식별자 등)는 숫자/문자열 검증이 미약하여 악성 페이로드 삽입 시 위험.

### 2.4 root cause (요약)

- **원인**: 외부에서 제공된 백업/복원 파일의 항목을 충분히 검증하지 않고 내부 설정으로 반영. 반영된 문자열이 셸 명령 실행 경로(또는 셸이 해석할 수 있는 컨텍스트)에 사용될 때 명령 주입 발생 가능.
- **증거**: 복원 처리 루틴에서 `Uci_Set_Str` 등으로 원문을 바로 저장하고 이후 `doSystem()` 또는 유사 API 호출이 존재하는 코드 패스가 확인됨(정적 리버스 엔지니어링 결과).

---

## 3. 동적(에뮬레이션) 분석 — 환경 구성

### 3.1 에뮬레이션 준비

- SquashFS 루트에 `qemu-*-static`을 복사하여 chroot 환경에서 `uhttpd`를 구동 시도.
- 필요한 바인드 마운트: `/dev`, `/proc` 등을 마운트.
- 일부 환경에서 LuCI 모듈 캐시( `tmp/luci-modulecache` 등 )를 삭제하여 최신 스크립트 로딩을 보장.

### 3.2 실행 중 발생한 문제(실제 목록)

1. **동적 라이브러리 부족**  
   - qemu chroot 환경에서 필요한 공유 라이브러리(`libubus`, `libuci`, `libubox`, libc 등)가 squashfs-root에 없거나 호환되지 않아 CGI/바이너리 실행 실패.
2. **권한/검증 로직**  
   - 일부 LuCI 모듈이 내부적으로 네트워크/호스트 상태(예: `check_ip_in_lan`)를 확인하며, 이로 인해 복원 작업이 거부되거나 추가 권한 우회가 필요.
3. **백업 복원 흐름에서의 리다이렉션**  
   - 복원 요청을 올리면 서버 측에서 연속적인 리다이렉트/세션 갱신 처리 발생. 에뮬레이션/리버스 환경에서는 리다이렉트 루프가 멈추지 않음.
4. **서비스 의존성**  
   - `ubusd`, `ubus` 데몬 등 RTOS/임베디드 서비스가 필요. 이들의 부재로 인해 일부 CGI 함수가 정상 동작하지 않음.

---

## 4. 익스플로잇 재현 시도 (요약 및 과정)

> 목표: 조작된 백업 파일을 만들어 업로드 → 복원 로직에서 악의 페이로드가 시스템 명령 경로에 반영되어 원격 명령 실행 유발.

### 4.1 준비한 절차 (실험 노트)

1. 펌웨어 추출 및 chroot + qemu 환경 구성.
2. 추출된 backup 파일(원본)을 복호화(있는 경우) 및 내부 XML/설정 파일 추출.
3. 취약 가능성이 높은 필드(예: `hostName`, `vlanVidCpu`, `someScriptParam`)에 쉘 메타문자/명령 삽입 시도:
   - 예: `test9' > /tmp/abc.txt #`
   - 예: `10; /bin/sh -c 'id > /tmp/out'; #`
4. 수정한 설정을 원래 형식으로 재포장(repack) — 압축 및 암호화 과정 필요하면 동일한 키/IV로 재생성.
5. 관리 UI(또는 API) 통해 복원 파일 업로드 및 동작 관찰.

### 4.2 관찰 결과 (시나리오별)

- **파일 포맷/암호화 일치**: 재포장한 파일이 서버에서 수락되는 흐름까지 도달했으나, 업로드 후 복원 핸들러에서 **계속적인 리다이렉트/세션 재검증**으로 실제 처리(복원 적용) 단계로 진입하지 못함.
- **의존 서비스 미구동**: `ubusd` 등 내부 서비스 미실행으로 인해 복원 프로세스 일부가 예외를 발생시킴(에러 로그 확인).
- **검증에 의한 차단**: 일부 입력은 서버 측에서 기본적인 형식 체크(숫자/문자 길이 등)로 인해 차단됨 — 이 경우 다른 필드로 우회 시도했으나 런타임 환경 제약으로 더 이상 진전 불가.
- **최종 결론**: 위 환경적 제약들로 인해 **최종적인 RCE(명령 실행 확인)를 달성하지 못함**.

---

## 5. 실패 원인 분석 및 남은 조사 포인트

### 5.1 실패 원인 (요약)

1. **에뮬레이션 한계**: qemu+chroot 기반 에뮬레이션에서 제조사 펌웨어가 요구하는 런타임(특정 데몬, 커널 인터페이스, 장치 파일 등)이 완전하게 제공되지 않음.
2. **서비스 의존성**: 복원 로직이 `ubus/ubusd`, `uci commit` 등 시스템 서비스와 연동되어 있고, 이들 부재 시 복원 로직이 정상적 흐름을 타지 않음.
3. **세션/인증 흐름**: 업로드/복원 API가 추가적인 세션 토큰/리다이렉트 로직을 요구하여 자동화가 복잡.
4. **백업 파일 포맷의 복잡성**: 다중 레이어(암호화 + zlib + 헤더)로 포장되어 재포장 과정에서 형식적 완전성을 맞추기 어려움.
5. **패치 가능성 존재**: 일부 코드 경로에서 이미 간단한 필터링/검증이 적용되어 있어 공격 성공 조건이 제한적일 수 있음(기기/버전에 따라 다름).

### 5.2 남은 조사 포인트

- **실 기기 테스트**: 안전한 격리 환경에서 실제 패치 이전 기기로 테스트하여 에뮬레이션 한계를 넘어 재현 시도 필요(법적·윤리적 승인 필요).
- **정교한 페이로드**: 복원 과정에서 실제 어떤 스크립트/명령이 값을 읽어 셸로 전달하는지 런타임 로깅을 통해 확인. (어떤 함수/스크립트가 문제인지 특정할수록 우회·검증 회피 가능성 파악)
- **추가 코드 패스 탐색**: 복원 핸들러 이외 다른 API(예: setWizardCfg, setWiFi* 등)에서 동일한 입력 반영 패턴이 있는지 추가 탐색.
- **패치 레벨 비교**: 패치된 펌웨어(가능하면 제조사 패치 노트 포함)와의 차이점(특히 문자열 → 인자 배열 전환, 허용값 화이트리스트화 등) 재확인.

---

## 6. 완화 방안 및 권고

### 6.1 개발자(제조사) 권고

1. **입력 검증(화이트리스트)**  
   - 백업/복원에서 읽어들인 모든 외부 문자열에 대해 엄격한 화이트리스트 또는 형식 검사(정규표현식, 길이 제한, 숫자 여부 등)를 수행.
2. **명령 실행 방식 개선**  
   - 임의 문자열을 쉘 문자열에 직접 결합하여 `os.execute()` 등으로 실행하는 대신, 명령과 인자를 분리하여 `execv`/`subprocess.call([cmd, arg1, arg2])` 식으로 사용.
3. **복원 파일 파싱 안전화**  
   - 복원 파일의 구조를 안전하게 파싱하고, 임시 파일 생성/권한 사용 시 경로를 고정하며, 임의의 쉘 확장을 허용하지 않음.
4. **로깅 및 모니터링**  
   - 복원 프로세스에서 비정상 패턴(예: 포함된 쉘 메타문자)을 검출하면 복원을 중단하고 관리자에게 알림.
5. **패치 배포 권장**  
   - 영향 받는 제품군에 대해 빠르게 패치를 배포하고, 패치 노트에 입력 유효성 강화 및 명령 실행 방식 변경 사항을 명시.

### 6.2 운영자(사용자) 권고

- 최신 펌웨어 적용: 제조사에서 제공하는 최신 펌웨어로 업데이트.
- 복원 파일 출처 검증: 신뢰할 수 없는 출처의 백업 파일 복원 금지.
- 관리자 인터페이스 접근 제한: 관리자 UI는 내부 네트워크에서만 접근하도록 방화벽/ACL 설정 권고.

---

## 7. 재현 체크리스트 (연구용)

- [ ] 펌웨어 추출 및 squashfs 루트 확보  
- [ ] qemu-static 주입 및 chroot 환경 구성  
- [ ] 필요한 동적 라이브러리(libubus, libuci 등) 확보/설치(가능하면)  
- [ ] ubusd 등 종속 서비스 구동  
- [ ] 백업 파일 형식(암호화·압축 방식) 완전 복원/재포장 스크립트 확보  
- [ ] 실장비(격리 네트워크)에서의 추가 검증(법적·윤리적 승인 필요)

---

## 8. 부록: 재현 시도에서 사용한 주요 명령/절차 (요약)

> 세부 스크립트/핵심 아이디어만 기재. 실제 공격 코드는 포함하지 않습니다.

- binwalk로 추출: `binwalk -Me firmware.bin`
- qemu 주입: `cp /usr/bin/qemu-arm-static squashfs-root/usr/bin/`
- chroot 바인드: `mount --bind /dev ./dev && mount --bind /proc ./proc`
- uhttpd 실행(예):  
  `chroot . /usr/bin/qemu-arm-static /usr/sbin/uhttpd -f -h /www -x /cgi-bin -p 0.0.0.0:80`
- 백업 복호화(예: AES+zlib 전개): `openssl aes-256-cbc -d -in backup.bin -K <KEY> -iv <IV> | python3 -c 'import sys,zlib;sys.stdout.buffer.write(zlib.decompress(sys.stdin.buffer.read()))'`

---

## 9. 결론 (요약)

- CVE-2024-38471은 복원(restore) 관련 처리에서 외부 입력 검증이 부족할 경우 **명령 주입 위험**을 갖는 구조적 취약점입니다.
- 본 문서 작성자는 로컬/에뮬레이션 환경에서 여러 재현 시도를 수행했으나, **환경적 제약(라이브러리·서비스·세션 흐름 등)**으로 인해 최종적인 원격 명령 실행 확인에는 실패했습니다.
- 실패는 취약성 자체의 부재를 의미하지 않으며, **실제 패치 이전 기기(격리된 시험 환경)**에서의 추가 검증이 필요합니다.
- 제조사에 의해 이미 유사 취약성들이 패치되는 추세이며(입력 검증 및 명령 실행 방식 변경), 영향받는 장비의 운영자는 **즉시 펌웨어 업데이트 및 복원 파일 출처 검증**을 권장합니다.

---

## 10. 참고 링크

- (예시) 제조사 보안 공지 페이지  
- 관련 CVE 데이터베이스(검색용)  
  - NVD: https://nvd.nist.gov/  
  - CIRCL / other mirrors

---

> **주의**: 본 문서의 기술적 세부사항은 연구·교육 목적이며, 타인 소유 장비에 대한 무단 시험은 법적·윤리적 문제가 될 수 있습니다. 실험은 항상 격리된 랩 환경에서만 수행하세요.
